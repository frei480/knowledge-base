---
tags:
  - АрхитектураПО
---

### Регулярный рефакторинг кода: стратегии и практики

Рефакторинг — это **систематический процесс улучшения структуры кода без изменения его поведения**. Вот как сделать его регулярной и эффективной практикой:

---

#### 1. **Интеграция в рабочий процесс**
- **Правило бойскаута**: "Оставляй код чище, чем ты его нашёл"
  ```python
  # До рефакторинга
  def calculate_total(items):
      total = 0
      for i in items:
          total += i.price * i.quantity
      return total
  
  # После: более читаемо
  def calculate_total(items):
      return sum(item.price * item.quantity for item in items)
  ```

- **Выделение времени**: Фиксируйте в спринте 10-20% времени на рефакторинг
- **Связь с задачами**: Рефакторите код при:
  - Исправлении багов
  - Добавлении новых функций
  - Code review

---

#### 2. **Когда проводить рефакторинг**
- **Код-смэллы** (запахи кода):
  - Дублирование кода
  - Длинные методы (>15 строк)
  - Большие классы (>400 строк)
  - Цикломатическая сложность >10
- **Перед добавлением функционала**: "Подготовительный рефакторинг"
- **После получения работающего кода**: Оптимизация "сырой" реализации

---

#### 3. **Инструментарий**
**Python:**
- Автоформатеры: `black`, `autopep8`
- Анализаторы: `pylint`, `flake8`
- Рефакторинг: `rope` (VSCode/PyCharm)
- Тестирование: `pytest`

**C#:**
- IDE: ReSharper, Visual Studio Refactoring Tools
- Анализ: SonarQube, Roslyn Analyzers
- Тестирование: NUnit/xUnit

---

#### 4. **Техники рефакторинга с примерами**
**А. Извлечение метода (Extract Method)**
```csharp
// До
public void PrintInvoice(Invoice invoice) 
{
    Console.WriteLine($"Customer: {invoice.Customer}");
    // ...20 строк печати...
}

// После
public void PrintInvoice(Invoice invoice) 
{
    PrintHeader(invoice);
    PrintBody(invoice);
    PrintFooter(invoice);
}
```

**Б. Замена магического числа константой**
```python
# До
def calculate_tax(income):
    return income * 0.13  # Что такое 0.13?

# После
TAX_RATE = 0.13
def calculate_tax(income):
    return income * TAX_RATE
```

**В. Упрощение условных выражений**
```csharp
// До
if (user.Role == "Admin" || user.Role == "Editor" || user.Role == "Owner") {...}

// После
private static readonly string[] _allowedRoles = {"Admin", "Editor", "Owner"};
if (_allowedRoles.Contains(user.Role)) {...}
```

---

#### 5. **Безопасные практики**
1. **Тесты как страховка**:
   - Покрывайте рефакторинг unit-тестами
   - Используйте TDD при существенных изменениях
2. **Малые шаги**:
   ```python
   # Вместо одного большого изменения:
   # 1. Переименовать переменную
   # 2. Вынести метод
   # 3. Упростить условие
   ```
3. **Версионный контроль**:
   - Коммитите после каждого небольшого изменения
   - Пишите осмысленные сообщения коммитов: "refactor: extract payment calculation"

---

#### 6. **План регулярного рефакторинга**
1. **Ежедневно**:
   - Устраняйте запахи кода при работе с файлами
   - Используйте автоформатеры перед коммитом
2. **Еженедельно**:
   - Анализируйте отчеты статических анализаторов
   - Выделяйте 2 часа на улучшение проблемных участков
3. **Каждый спринт**:
   - Включайте в бэклог технические задачи
   - Рефакторите перед добавлением нового функционала
4. **Ежеквартально**:
   - Аудит кодовой базы
   - Обновляйте стандарты кодирования

---

#### 7. **Преодоление сопротивления в команде**
- **Демонстрируйте выгоды**:
  ```markdown
  | Метрика       | До рефакторинга | После |
  |---------------|-----------------|-------|
  | Время выполнения | 120 мс        | 45 мс |
  | Количество багов | 15/мес        | 3/мес |
  ```
- **Начните с low-risk зон**:
  - Тестовые классы
  - Утилитарные функции
  - Устаревший неиспользуемый код
- **Автоматизируйте рутину**:
  - Настройте pre-commit хуки для форматирования
  - Используйте CI/CD для проверки качества

---

#### 8. **Опасные моменты (когда НЕ рефакторить)**
1. Перед важным релизом
2. В кризисных ситуациях (продакшн-инциденты)
3. Код, который будет удалён в ближайшее время
4. Без тестового покрытия для критических компонентов

---

#### 9. **Метрики эффективности**
Отслеживайте эти показатели:
1. **Технический долг** (через SonarQube)
2. **Количество кода-дубликата**
3. **Средняя сложность методов**
4. **Время сборки и выполнения тестов**
5. **Количество багов в рефакторенных модулях**

---

### Пример плана рефакторинга для C#-проекта
```markdown
| Неделя | Область         | Действие                      | Инструменты         |
|--------|-----------------|-------------------------------|---------------------|
| 1      | Сервисы оплаты | Извлечение интерфейсов        | ReSharper           |
| 2      | Валидация      | Замена условий полиморфизмом  | Visual Studio       |
| 3      | API-контроллеры| Упрощение методов >100 строк  | SonarQube + Roslyn |
| 4      | Тесты          | Удаление дублирования         | NUnit + Moq        |
```

**Итог**: Регулярный рефакторинг — как гигиена полости рта для кода. Небольшие ежедневные усилия предотвращают катастрофические проблемы в будущем. Начните с малого: выделите 15 минут сегодня для улучшения одного метода, который вас раздражает!