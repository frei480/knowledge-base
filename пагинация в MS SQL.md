---
tags:
  - SQL
---
Пагинация в MS SQL Server может быть организована с помощью различных методов, но наиболее распространенные и современные подходы используют конструкции OFFSET и FETCH NEXT. Эти конструкции были введены в SQL Server 2012 и позволяют легко реализовать пагинацию.

▎Пример использования OFFSET и FETCH NEXT

Предположим, у вас есть таблица Employees, и вы хотите получить данные о сотрудниках с пагинацией. Вот как это можно сделать:
```sql
DECLARE @PageNumber INT = 2;  -- Номер страницы
DECLARE @PageSize INT = 10;   -- Количество записей на странице

SELECT *
FROM Employees
ORDER BY EmployeeID  -- Обязательно укажите порядок сортировки
OFFSET (@PageNumber - 1) * @PageSize ROWS  -- Пропускаем строки
FETCH NEXT @PageSize ROWS ONLY;  -- Получаем следующую порцию строк
```

▎Объяснение:
1. ORDER BY: Пагинация требует явного указания порядка сортировки. Без него SQL Server не сможет определить, какие строки нужно пропустить и какие выбрать.
2. OFFSET: Указывает, сколько строк нужно пропустить. В данном случае, если номер страницы равен 2 и размер страницы равен 10, то мы пропустим первые 10 записей (то есть все записи первой страницы).
3. FETCH NEXT: Указывает, сколько строк нужно вернуть после пропуска. В нашем примере мы получаем следующие 10 записей.

▎Альтернативный метод: Использование ROW_NUMBER()
Если вы используете более старую версию SQL Server (до 2012 года) или хотите использовать другой подход, вы можете воспользоваться функцией ROW_NUMBER().
```sql
DECLARE @PageNumber INT = 2;  -- Номер страницы
DECLARE @PageSize INT = 10;   -- Количество записей на странице

WITH EmployeeCTE AS (
    SELECT *,
           ROW_NUMBER() OVER (ORDER BY EmployeeID) AS RowNum
    FROM Employees
)
SELECT *
FROM EmployeeCTE
WHERE RowNum BETWEEN (@PageNumber - 1) * @PageSize + 1 AND @PageNumber * @PageSize;
```


▎Объяснение:
1. ROW_NUMBER(): Эта функция присваивает уникальный номер каждой строке в наборе результатов в соответствии с указанным порядком сортировки.
2. CTE (Common Table Expression): Мы используем CTE для создания временного набора данных с номерами строк.
3. WHERE: Мы выбираем строки, номера которых находятся в заданном диапазоне для текущей страницы.

▎Заключение
Оба метода позволяют эффективно организовать пагинацию в MS SQL Server. Выбор между ними зависит от версии SQL Server и ваших предпочтений. Метод с `OFFSET` и `FETCH NEXT` проще и более читаем, но метод с ROW_NUMBER() может быть полезен в более сложных сценариях или для совместимости со старыми версиями SQL Server.