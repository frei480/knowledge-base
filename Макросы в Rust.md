---
tags:
  - rust
---
–û—Ç–ª–∏—á–Ω–æ! –ú–∞–∫—Ä–æ—Å—ã –≤ Rust ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç **–º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è**, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏. –û–Ω–∏ –±—ã–≤–∞—é—Ç –¥–≤—É—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤: **–¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ** (`macro_rules!`) –∏ **–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ** (custom derive, –∞—Ç—Ä–∏–±—É—Ç–Ω—ã–µ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ). –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –∏—Ö –¥–µ—Ç–∞–ª—å–Ω–æ.

---

# üìå 1. [[–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã –≤ Rust|–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã]] (`macro_rules!`)
–°–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–∏–ø. –†–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ **—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –æ–±—Ä–∞–∑—Ü–æ–º** (pattern matching).

## –ë–∞–∑–æ–≤—ã–π –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```rust
macro_rules! my_macro {
    // –ü–∞—Ç—Ç–µ—Ä–Ω => –ö–æ–¥-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
    ($x:expr) => {
        println!("–ó–Ω–∞—á–µ–Ω–∏–µ: {}", $x);
    };
    ($($x:expr),*) => {
        $(
            println!("{}", $x);
        )*
    };
}
```

## –ü—Ä–∏–º–µ—Ä: –ó–Ω–∞–º–µ–Ω–∏—Ç—ã–π `vec!`
```rust
macro_rules! vec {
    () => { Vec::new() };  // –ü—É—Å—Ç–æ–π –≤–µ–∫—Ç–æ—Ä
    ($($x:expr),+ $(,)?) => {  // –û–¥–∏–Ω –∏–ª–∏ –±–æ–ª–µ–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        {
            let mut temp_vec = Vec::new();
            $(
                temp_vec.push($x);
            )*
            temp_vec
        }
    };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
let v = vec![1, 2, 3];
```

## –ö–ª—é—á–µ–≤—ã–µ –≠–ª–µ–º–µ–Ω—Ç—ã:
- **–ó–∞—Ö–≤–∞—Ç—á–∏–∫–∏ (captures):**
  `$x:expr` ‚Äî –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, `$i:ident` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, `$t:ty` ‚Äî —Ç–∏–ø
- **–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ–ª–∏ (repetitions):**
  `*` (0+ —Ä–∞–∑), `+` (1+ —Ä–∞–∑), `?` (0 –∏–ª–∏ 1 —Ä–∞–∑)
- **–ü—Ä–∏–º–µ—Ä —Å HTML-–±–∏–ª–¥–µ—Ä–æ–º:**
  ```rust
  macro_rules! html {
      (<$tag>$content:tt</$closetag>) => { ... };
  }
  ```

---

# ‚öôÔ∏è 2. [[–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã –≤ Rust|–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã]]
–ë–æ–ª–µ–µ –º–æ—â–Ω—ã–µ, –Ω–æ —Å–ª–æ–∂–Ω—ã–µ. –†–µ–∞–ª–∏–∑—É—é—Ç—Å—è –∫–∞–∫ **–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫—Ä–µ–π—Ç—ã** (`proc-macro = true` –≤ `Cargo.toml`).

## –¢—Ä–∏ –ü–æ–¥–≤–∏–¥–∞:
1. **[[–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã –≤ Rust#üõ†Ô∏è 1. Derive-–º–∞–∫—Ä–æ—Å—ã|Custom Derive Macros]]**
   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∞–ª–∏–∑—É—é—Ç —Ç—Ä–µ–π—Ç—ã –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä:
   ```rust
   #[derive(Serialize, Debug)]
   struct User { name: String }
   ```

2. **[[–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã –≤ Rust#üè∑Ô∏è 2. –ê—Ç—Ä–∏–±—É—Ç–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã|Attribute-Like Macros]]**
   –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞:
   ```rust
   #[route(GET, "/")]
   fn index() { ... }
   ```

3. **[[–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã –≤ Rust#üìû 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã|Function-Like Macros]]**
   –í—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π:
   ```rust
   let sql = sql!(SELECT * FROM users);
   ```

---

# üõ†Ô∏è –ö–∞–∫ –†–∞–±–æ—Ç–∞—é—Ç –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã?
1. **–í—Ö–æ–¥:** `TokenStream` (–∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥)
2. **–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:** –í AST —Å –ø–æ–º–æ—â—å—é `syn`
3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞:** –° –ø–æ–º–æ—â—å—é `quote`
4. **–í—ã—Ö–æ–¥:** –ù–æ–≤—ã–π `TokenStream`

## –ü—Ä–∏–º–µ—Ä: Custom Derive –î–ª—è `HelloMacro`
```rust
// –ö—Ä–µ–π—Ç proc-macro
use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, DeriveInput};

#[proc_macro_derive(HelloMacro)]
pub fn hello_macro_derive(input: TokenStream) -> TokenStream {
    let ast = parse_macro_input!(input as DeriveInput);
    let name = &ast.ident;
    
    quote! {
        impl HelloMacro for #name {
            fn hello() {
                println!("Hello from {}!", stringify!(#name));
            }
        }
    }.into()
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```rust
#[derive(HelloMacro)]
struct Pancakes;

fn main() {
    Pancakes::hello(); // "Hello from Pancakes!"
}
```

---

# üåü –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ú–∞–∫—Ä–æ—Å—ã –í –≠–∫–æ—Å–∏—Å—Ç–µ–º–µ
1. **`println!` / `format!`**
   –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ (—Å–∏—Å—Ç–µ–º–∞ –º–∞–∫—Ä–æ—Å–æ–≤ —Å–ª–æ–∂–Ω–µ–µ `format_args!`)

2. **`lazy_static!`**
   –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
   ```rust
   lazy_static! {
       static ref CONFIG: HashMap<String, String> = load_config();
   }
   ```

3. **`tokio::main`**
   –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç async fn –≤ —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞:
   ```rust
   #[tokio::main]
   async fn main() { ... }
   ```

4. **`serde_derive`**
   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
   ```rust
   #[derive(Serialize, Deserialize)]
   struct Data { ... }
   ```

---

# ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ò –ü–æ–¥–≤–æ–¥–Ω—ã–µ –ö–∞–º–Ω–∏
1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏**
   –û—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–¥–µ
2. **–í—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**
   –¢—è–∂—ë–ª—ã–µ –º–∞–∫—Ä–æ—Å—ã –∑–∞–º–µ–¥–ª—è—é—Ç —Å–±–æ—Ä–∫—É
3. **–ü–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞**
   –¢—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è AST –∏ —Ç–æ–∫–µ–Ω–æ–≤
4. **–ü—Ä–∞–≤–∏–ª–æ –≥–∏–≥–∏–µ–Ω—ã**
   –ú–∞–∫—Ä–æ—Å—ã –Ω–µ "–≤–∏–¥—è—Ç" –≤–Ω–µ—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
   ```rust
   macro_rules! broken {
       () => { x + 1 }; // –û—à–∏–±–∫–∞: `x` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
   }
   ```

---

# üí° Best Practices
1. **–ò–∑–±–µ–≥–∞–π—Ç–µ –º–∞–∫—Ä–æ—Å–æ–≤, –≥–¥–µ —Ö–≤–∞—Ç–∏—Ç —Ñ—É–Ω–∫—Ü–∏–π**
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `macro_rules!` –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á**
3. **–î–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ ‚Äî –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã**
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —á–µ—Ä–µ–∑ `cargo expand`**:
   ```bash
   cargo install cargo-expand
   cargo expand
   ```

---

# üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
1. **`cargo expand`** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –∫–æ–¥–∞
2. **`syn` + `quote`** ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞
3. **`proc-macro2`** ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

---

# üéì –ü—Ä–∏–º–µ—Ä: –ú–∞–∫—Ä–æ—Å –î–ª—è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```rust
macro_rules! auto_test {
    ($name:ident($($arg:ty),*) -> $ret:ty) => {
        paste::item! {
            #[test]
            fn [< test_ $name >]() {
                let result = $name(<$arg>::default(), <$arg>::default());
                assert_eq!(result, <$ret>::default());
            }
        }
    };
}

auto_test!(add(i32, i32) -> i32); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç test_add
```

---

# üíé –ó–∞—á–µ–º –ù—É–∂–Ω—ã –ú–∞–∫—Ä–æ—Å—ã?
1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞** (–∫–∞–∫ derive)
2. **–°–æ–∑–¥–∞–Ω–∏–µ DSL** (Domain-Specific Languages)
   ```rust
   html! { <div class="header">{"Hello"}</div> }
   ```
3. **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** –∫–∞–∫ `sqlx::query!`
4. **–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏** (–∫–∞–∫ `#[tokio::main]`)

---

# üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –° –î—Ä—É–≥–∏–º–∏ –Ø–∑—ã–∫–∞–º–∏
| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å          | Rust              | C/C++            | Lisp             |
|----------------------|-------------------|------------------|------------------|
| –¢–∏–ø –º–∞–∫—Ä–æ—Å–æ–≤         | –ì–∏–≥–∏–µ–Ω–∏—á–Ω—ã–µ       | –¢–µ–∫—Å—Ç–æ–≤—ã–µ        | AST-–º–∞–∫—Ä–æ—Å—ã      |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å         | –í—ã—Å–æ–∫–∞—è           | –ù–∏–∑–∫–∞—è           | –ó–∞–≤–∏—Å–∏—Ç          |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å            | –°—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è   | –ù–∏–∑–∫–∞—è           | –í—ã—Å–æ–∫–∞—è          |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —è–∑—ã–∫–æ–º  | –ò–¥–µ–∞–ª—å–Ω–∞—è         | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è     | –ü–æ–ª–Ω–∞—è           |

---

# üèÅ –ò—Ç–æ–≥
–ú–∞–∫—Ä–æ—Å—ã –≤ Rust ‚Äî —ç—Ç–æ:
- **–ú–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è**
- **–î–≤–∞ —Ç–∏–ø–∞:** –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ (–ø—Ä–æ—â–µ) –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ (–º–æ—â–Ω–µ–µ)
- **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
  - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
  - –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö DSL
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∏–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
- **–õ—É—á—à–∏–µ –¥—Ä—É–∑—å—è:** `syn`, `quote`, `cargo-expand`
